{% extends 'store/base.html' %}
{% load static %}

{% block content %}
<div class="order-page-wrapper">
    <div class="order-form-card">
        
        <h2 class="form-title">
            {% if editing %} ‚úèÔ∏è {{ t.edit_order_title }} {% else %} üöÄ {{ t.create_order_title }} {% endif %}
        </h2>
        <p class="form-subtitle">{{ t.order_subtitle }}</p>

        {% if messages %}
            {% for message in messages %}
                <div class="alert-box {{ message.tags }}">
                    {% if message.tags == 'error' %}‚ùå{% else %}‚úÖ{% endif %} {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="orderForm">
            {% csrf_token %}

            <div id="items-container">
                
                {% if editing and order %}
                    {% for item in order.items.all %}
                    <div class="item-row">
                        <div class="row-header">
                            <span class="item-number">{{ t.item_label }} #{{ forloop.counter }}</span>
                            {% if not forloop.first %}
                            <button type="button" class="btn-remove" onclick="this.parentElement.parentElement.remove()">
                                <i class="fa-solid fa-trash"></i> {{ t.remove_btn }}
                            </button>
                            {% endif %}
                        </div>
                        <div class="input-group">
                            <label>{{ t.shein_link_label }}</label>
                            <input type="text" name="links[]" value="{{ item.product_link }}" placeholder="{{ t.link_placeholder }}" required class="form-input">
                        </div>
                        <div class="input-group">
                            <label>{{ t.price_label }}</label>
                            <input type="number" name="prices[]" value="{{ item.manual_price_usd }}" step="0.01" placeholder="{{ t.price_placeholder }}" required class="form-input">
                        </div>
                    </div>
                    {% endfor %}
                
                {% else %}
                    <div class="item-row">
                        <div class="row-header">
                            <span class="item-number">{{ t.item_label }} #1</span>
                        </div>
                        <div class="input-group">
                            <label>{{ t.shein_link_label }}</label>
                            <input type="text" name="links[]" placeholder="{{ t.link_placeholder }}" required class="form-input">
                        </div>
                        <div class="input-group">
                            <label>{{ t.price_label }}</label>
                            <input type="number" name="prices[]" step="0.01" placeholder="{{ t.price_placeholder }}" required class="form-input">
                            <small style="color: var(--text-muted);">{{ t.price_help_text }}</small>
                        </div>
                    </div>
                {% endif %}

            </div>

            <button type="button" class="btn-add-item" onclick="addNewItem()">
                <i class="fa-solid fa-plus"></i> {{ t.add_another_item }}
            </button>

            <hr class="divider">

            <div class="input-group">
                <label>{{ t.screenshots_label }}</label>
                
                <div class="file-upload-wrapper">
                    <input type="file" name="screenshots" multiple accept="image/*" id="fileInput">
                    <label for="fileInput" class="file-label" id="uploadLabel">
                        <i class="fa-solid fa-camera"></i> {{ t.upload_btn_text }}
                    </label>
                </div>
                
                <div id="fileNameDisplay"></div>

                {% if editing and order.screenshots.all %}
                <div style="margin-top: 15px;">
                    <p style="font-size: 0.85rem; font-weight: bold; color: var(--text-muted);">{{ t.current_screenshots }}:</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        {% for ss in order.screenshots.all %}
                            <a href="{{ ss.image.url }}" target="_blank">
                                <img src="{{ ss.image.url }}" class="screenshot-thumb">
                            </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="points-section">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div class="points-text">
                        <strong>üíé {{ t.my_points }}: {{ profile.dalin_points }}</strong>
                        <p>1 {{ t.point_unit }} = {{ point_value }} IQD {{ t.discount }}</p>
                    </div>
                    {% if profile.dalin_points > 0 %}
                    <label class="switch">
                        <input type="checkbox" name="use_points" {% if order.wants_to_use_points %}checked{% endif %}>
                        <span class="slider round"></span>
                    </label>
                    {% else %}
                    <span style="font-size: 0.8rem; color: var(--text-muted);">{{ t.no_points }}</span>
                    {% endif %}
                </div>
            </div>

            {% if missing_profile %}
            <div class="delivery-section">
                <h4 style="color: #e67e22; margin-bottom: 15px; margin-top: 0;"><i class="fa-solid fa-map-pin"></i> {{ t.delivery_details }}</h4>
                <div class="input-group">
                    <label>{{ t.phone_number }}</label>
                    <input type="text" name="phone" placeholder="0750 XXX XX XX" required class="form-input">
                </div>
                <div class="input-group">
                    <label>{{ t.city }}</label>
                    <select name="city" class="form-input" required>
                        <option value="">{{ t.select_city }}</option>
                        <option value="Erbil">{{ t.erbil }}</option>
                        <option value="Suleymaniyah">{{ t.suleymaniyah }}</option>
                        <option value="Duhok">{{ t.duhok }}</option>
                        <option value="Kirkuk">{{ t.kirkuk }}</option>
                        <option value="Baghdad">{{ t.baghdad }}</option>
                        <option value="Mosul">{{ t.mosul }}</option>
                        <option value="Other">{{ t.other }}</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>{{ t.full_address }}</label>
                    <textarea name="address" rows="2" placeholder="{{ t.address_placeholder }}" required class="form-input"></textarea>
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn-submit">
                {% if editing %} üíæ {{ t.update_order_btn }} {% else %} üßÆ {{ t.calculate_preview_btn }} {% endif %}
            </button>

        </form>
    </div>
</div>

<script>
    // 1. YENƒ∞ √úR√úN EKLEME (JS i√ßinde dil deƒüi≈ükenlerini kullanƒ±yoruz)
    function addNewItem() {
        const container = document.getElementById('items-container');
        const itemCount = container.querySelectorAll('.item-row').length + 1;

        const newRow = document.createElement('div');
        newRow.classList.add('item-row');
        // JS i√ßindeki HTML'de de √ßevirileri kullanƒ±yoruz
        newRow.innerHTML = `
            <div class="row-header">
                <span class="item-number">{{ t.item_label }} #${itemCount}</span>
                <button type="button" class="btn-remove" onclick="this.parentElement.parentElement.remove()">
                    <i class="fa-solid fa-trash"></i> {{ t.remove_btn }}
                </button>
            </div>
            <div class="input-group">
                <label>{{ t.shein_link_label }}</label>
                <input type="text" name="links[]" placeholder="{{ t.link_placeholder }}" required class="form-input">
            </div>
            <div class="input-group">
                <label>{{ t.price_label }}</label>
                <input type="number" name="prices[]" step="0.01" placeholder="{{ t.price_placeholder }}" required class="form-input">
            </div>
        `;
        container.appendChild(newRow);
    }

    // 2. DOSYA SE√áƒ∞Mƒ∞ G√ñSTERGESƒ∞
    const fileInput = document.getElementById('fileInput');
    const uploadLabel = document.getElementById('uploadLabel');
    const fileNameDisplay = document.getElementById('fileNameDisplay');

    fileInput.addEventListener('change', function(e) {
        const count = e.target.files.length;
        if (count > 0) {
            uploadLabel.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
            uploadLabel.style.borderColor = '#2ecc71';
            uploadLabel.style.color = '#27ae60';
            // JS i√ßinde dinamik metin (Tekil/√áoƒüul ayrƒ±mƒ± basit√ße yapƒ±ldƒ±)
            uploadLabel.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${count} {{ t.photos_selected }}`;
            
            let names = [];
            for(let i=0; i<count; i++) {
                names.push(e.target.files[i].name);
            }
            fileNameDisplay.textContent = names.join(', ');
        } else {
            uploadLabel.style.backgroundColor = 'var(--bg-body)';
            uploadLabel.style.borderColor = 'transparent';
            uploadLabel.style.color = 'var(--text-muted)';
            uploadLabel.innerHTML = `<i class="fa-solid fa-camera"></i> {{ t.upload_btn_text }}`;
            fileNameDisplay.textContent = '';
        }
    });
</script>

<style>
    /* GENEL */
    .order-page-wrapper { 
        min-height: 90vh; display: flex; justify-content: center; padding: 40px 20px; 
        background: var(--bg-body); 
        /* Font otomatik translations.py'den geliyor */
    }
    
    .order-form-card { 
        background: var(--bg-surface); 
        width: 100%; max-width: 600px; padding: 40px; 
        border-radius: 20px; 
        box-shadow: var(--shadow); 
        border: 1px solid var(--border-color);
    }
    
    .form-title { text-align: center; color: var(--text-main); margin-bottom: 10px; font-weight: 800; font-size: 1.8rem; }
    .form-subtitle { text-align: center; color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem; }

    /* ALERT KUTUSU */
    .alert-box {
        padding: 15px; border-radius: 10px; margin-bottom: 20px; 
        font-weight: 500; font-size: 0.95rem; display: flex; align-items: center; gap: 10px;
    }
    .alert-box.success { background: rgba(40, 167, 69, 0.1); color: #28a745; border: 1px solid rgba(40, 167, 69, 0.2); }
    .alert-box.error { background: rgba(220, 53, 69, 0.1); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.2); }

    /* KUTULAR (ITEMS) */
    .item-row { 
        background: var(--bg-surface); 
        border: 1px solid var(--border-color); 
        padding: 20px; border-radius: 12px; margin-bottom: 20px; 
        position: relative; transition: 0.3s; 
    }
    .item-row:hover { 
        border-color: var(--color-accent); 
        box-shadow: 0 5px 15px rgba(0,0,0,0.03); 
    }
    
    .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    
    .item-number { 
        font-weight: bold; color: var(--text-main); 
        background: var(--bg-bar); 
        padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; 
    }
    
    .btn-remove { 
        background: none; border: none; color: #e74c3c; 
        cursor: pointer; font-size: 0.85rem; font-weight: 600; 
        display: flex; align-items: center; gap: 5px; 
    }
    
    .input-group { margin-bottom: 15px; }
    
    .input-group label { 
        display: block; margin-bottom: 8px; font-weight: 600; 
        color: var(--text-muted); font-size: 0.9rem; 
    }
    
    .form-input { 
        width: 100%; padding: 12px; 
        border: 2px solid var(--border-color); 
        border-radius: 10px; font-size: 1rem; transition: 0.3s; 
        box-sizing: border-box; font-family: inherit;
        background: var(--bg-body); color: var(--text-main);
    }
    .form-input:focus { 
        border-color: var(--color-accent); 
        outline: none; background: var(--bg-surface); 
    }

    /* BUTONLAR */
    .btn-add-item { 
        width: 100%; padding: 15px; 
        background: var(--bg-surface); 
        border: 2px dashed var(--border-color); 
        color: var(--text-muted); 
        border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; 
        display: flex; justify-content: center; align-items: center; gap: 10px; 
    }
    .btn-add-item:hover { 
        border-color: var(--color-accent); 
        color: var(--color-accent); 
        background: rgba(255, 0, 85, 0.05); 
    }
    
    .btn-submit { 
        width: 100%; padding: 18px; 
        background: var(--text-main); color: var(--bg-surface); 
        border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 20px; 
    }
    .btn-submit:hover { 
        background: var(--color-accent); 
        color: white;
        transform: translateY(-3px); 
    }

    .divider { margin: 30px 0; border: 0; border-top: 1px solid var(--border-color); }

    /* DOSYA Y√úKLEME */
    .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
    .file-upload-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    
    .file-label { 
        display: block; padding: 15px; 
        background: var(--bg-bar); 
        text-align: center; border-radius: 10px; font-weight: 600; 
        color: var(--text-muted); cursor: pointer; 
        border: 2px solid transparent; transition: 0.3s; 
    }
    
    .screenshot-thumb {
        width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color);
    }
    
    #fileNameDisplay { margin-top: 10px; font-size: 0.85rem; color: var(--color-accent); font-weight: 600; }

    /* PUAN SWITCH */
    .points-section { 
        background: rgba(142, 68, 173, 0.05); /* Morumsu hafif zemin */
        padding: 15px; border-radius: 12px; 
        border: 1px solid rgba(142, 68, 173, 0.1); 
        margin-bottom: 20px; 
    }
    .points-text strong { color: var(--text-main); }
    .points-text p { font-size: 0.8rem; color: var(--text-muted); margin: 3px 0 0 0; }

    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--color-accent); }
    input:checked + .slider:before { transform: translateX(24px); }
    
    /* TESLƒ∞MAT B√ñL√úM√ú */
    .delivery-section { 
        background: rgba(230, 126, 34, 0.05); /* Turuncu hafif zemin */
        padding: 20px; border-radius: 12px; 
        border: 1px solid rgba(230, 126, 34, 0.2); 
        margin-bottom: 20px; 
    }
</style>
{% endblock %}