{% extends 'store/base.html' %}
{% load static %}

{% block content %}
<div class="order-page-wrapper">
    <div class="order-form-card">
        
        <h2 class="form-title">
            {% if editing %} ‚úèÔ∏è Edit Order {% else %} üöÄ Create New Order {% endif %}
        </h2>
        <p class="form-subtitle">Paste your Shein links below. We calculate the total instantly.</p>

        {% if messages %}
            {% for message in messages %}
                <div class="alert {{ message.tags }}">
                    {% if message.tags == 'error' %}‚ùå{% else %}‚úÖ{% endif %} {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="orderForm">
            {% csrf_token %}

            <div id="items-container">
                
                {% if editing and order %}
                    {% for item in order.items.all %}
                    <div class="item-row">
                        <div class="row-header">
                            <span class="item-number">Item #{{ forloop.counter }}</span>
                            {% if not forloop.first %}
                            <button type="button" class="btn-remove" onclick="this.parentElement.parentElement.remove()">
                                <i class="fa-solid fa-trash"></i> Remove
                            </button>
                            {% endif %}
                        </div>
                        <div class="input-group">
                            <label>Shein Product Link</label>
                            <input type="text" name="links[]" value="{{ item.product_link }}" placeholder="Paste link here..." required class="form-input">
                        </div>
                        <div class="input-group">
                            <label>Price ($ USD)</label>
                            <input type="number" name="prices[]" value="{{ item.manual_price_usd }}" step="0.01" placeholder="e.g. 12.50" required class="form-input">
                        </div>
                    </div>
                    {% endfor %}
                
                {% else %}
                    <div class="item-row">
                        <div class="row-header">
                            <span class="item-number">Item #1</span>
                        </div>
                        <div class="input-group">
                            <label>Shein Product Link</label>
                            <input type="text" name="links[]" placeholder="Paste link here..." required class="form-input">
                        </div>
                        <div class="input-group">
                            <label>Price ($ USD)</label>
                            <input type="number" name="prices[]" step="0.01" placeholder="e.g. 12.50" required class="form-input">
                            <small style="color: #888;">Enter the price you see on Shein app.</small>
                        </div>
                    </div>
                {% endif %}

            </div>

            <button type="button" class="btn-add-item" onclick="addNewItem()">
                <i class="fa-solid fa-plus"></i> Add Another Item
            </button>

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

            <div class="input-group">
                <label>Cart Screenshots (Optional)</label>
                
                <div class="file-upload-wrapper">
                    <input type="file" name="screenshots" multiple accept="image/*" id="fileInput">
                    
                    <label for="fileInput" class="file-label" id="uploadLabel">
                        <i class="fa-solid fa-camera"></i> Click to Upload Photos
                    </label>
                </div>
                
                <div id="fileNameDisplay" style="margin-top: 10px; font-size: 0.85rem; color: #ff0055; font-weight: 600;"></div>

                {% if editing and order.screenshots.all %}
                <div style="margin-top: 15px;">
                    <p style="font-size: 0.85rem; font-weight: bold; color: #555;">Current Screenshots:</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        {% for ss in order.screenshots.all %}
                            <a href="{{ ss.image.url }}" target="_blank">
                                <img src="{{ ss.image.url }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;">
                            </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="points-section">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div class="points-text">
                        <strong>üíé My Points: {{ profile.dalin_points }}</strong>
                        <p style="font-size: 0.8rem; color: #666;">1 Point = {{ point_value }} IQD Discount</p>
                    </div>
                    {% if profile.dalin_points > 0 %}
                    <label class="switch">
                        <input type="checkbox" name="use_points" {% if order.wants_to_use_points %}checked{% endif %}>
                        <span class="slider round"></span>
                    </label>
                    {% else %}
                    <span style="font-size: 0.8rem; color: #999;">No points</span>
                    {% endif %}
                </div>
            </div>

            {% if missing_profile %}
            <div class="delivery-section">
                <h4 style="color: #e67e22; margin-bottom: 15px;"><i class="fa-solid fa-map-pin"></i> Delivery Details</h4>
                <div class="input-group">
                    <label>Phone Number</label>
                    <input type="text" name="phone" placeholder="0750 XXX XX XX" required class="form-input">
                </div>
                <div class="input-group">
                    <label>City</label>
                    <select name="city" class="form-input" required>
                        <option value="">Select City...</option>
                        <option value="Erbil">Erbil</option>
                        <option value="Suleymaniyah">Suleymaniyah</option>
                        <option value="Duhok">Duhok</option>
                        <option value="Kirkuk">Kirkuk</option>
                        <option value="Baghdad">Baghdad</option>
                        <option value="Mosul">Mosul</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Full Address</label>
                    <textarea name="address" rows="2" placeholder="Neighborhood, Street, House No..." required class="form-input"></textarea>
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn-submit">
                {% if editing %} üíæ Update Order {% else %} üßÆ Calculate & Preview {% endif %}
            </button>

        </form>
    </div>
</div>

<script>
    // 1. YENƒ∞ √úR√úN EKLEME
    function addNewItem() {
        const container = document.getElementById('items-container');
        const itemCount = container.querySelectorAll('.item-row').length + 1;

        const newRow = document.createElement('div');
        newRow.classList.add('item-row');
        newRow.innerHTML = `
            <div class="row-header">
                <span class="item-number">Item #${itemCount}</span>
                <button type="button" class="btn-remove" onclick="this.parentElement.parentElement.remove()">
                    <i class="fa-solid fa-trash"></i> Remove
                </button>
            </div>
            <div class="input-group">
                <label>Shein Product Link</label>
                <input type="text" name="links[]" placeholder="Paste link here..." required class="form-input">
            </div>
            <div class="input-group">
                <label>Price ($ USD)</label>
                <input type="number" name="prices[]" step="0.01" placeholder="e.g. 12.50" required class="form-input">
            </div>
        `;
        container.appendChild(newRow);
    }

    // 2. DOSYA SE√áƒ∞Mƒ∞ G√ñSTERGESƒ∞ (BU KISIM D√úZELTƒ∞LDƒ∞)
    const fileInput = document.getElementById('fileInput');
    const uploadLabel = document.getElementById('uploadLabel');
    const fileNameDisplay = document.getElementById('fileNameDisplay');

    fileInput.addEventListener('change', function(e) {
        const count = e.target.files.length;
        if (count > 0) {
            // Label'ƒ±n rengini ve yazƒ±sƒ±nƒ± deƒüi≈ütir
            uploadLabel.style.backgroundColor = '#e8f5e9';
            uploadLabel.style.borderColor = '#2ecc71';
            uploadLabel.style.color = '#27ae60';
            uploadLabel.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${count} Photo(s) Selected!`;
            
            // Dosya isimlerini altƒ±na yaz (Opsiyonel ama ho≈ü)
            let names = [];
            for(let i=0; i<count; i++) {
                names.push(e.target.files[i].name);
            }
            fileNameDisplay.textContent = names.join(', ');
        } else {
            // ƒ∞ptal ederse eski haline d√∂nd√ºr
            uploadLabel.style.backgroundColor = '#f1f1f1';
            uploadLabel.style.borderColor = 'transparent';
            uploadLabel.style.color = '#555';
            uploadLabel.innerHTML = `<i class="fa-solid fa-camera"></i> Click to Upload Photos`;
            fileNameDisplay.textContent = '';
        }
    });
</script>

<style>
    /* GENEL */
    .order-page-wrapper { min-height: 90vh; display: flex; justify-content: center; padding: 40px 20px; background: #f8f9fa; }
    .order-form-card { background: white; width: 100%; max-width: 600px; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .form-title { text-align: center; color: #333; margin-bottom: 10px; font-weight: 800; font-size: 1.8rem; }
    .form-subtitle { text-align: center; color: #777; margin-bottom: 30px; font-size: 0.95rem; }

    /* KUTULAR */
    .item-row { background: #fff; border: 1px solid #e0e0e0; padding: 20px; border-radius: 12px; margin-bottom: 20px; position: relative; transition: 0.3s; }
    .item-row:hover { border-color: #ff0055; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
    .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .item-number { font-weight: bold; color: #333; background: #eee; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; }
    .btn-remove { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
    
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 0.9rem; }
    .form-input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; transition: 0.3s; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    .form-input:focus { border-color: #ff0055; outline: none; background: #fffbfd; }

    /* BUTONLAR */
    .btn-add-item { width: 100%; padding: 15px; background: white; border: 2px dashed #ccc; color: #666; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .btn-add-item:hover { border-color: #ff0055; color: #ff0055; background: #fff0f5; }
    .btn-submit { width: 100%; padding: 18px; background: #111; color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 20px; }
    .btn-submit:hover { background: #ff0055; transform: translateY(-3px); }

    /* DOSYA Y√úKLEME */
    .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
    .file-upload-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    .file-label { display: block; padding: 15px; background: #f1f1f1; text-align: center; border-radius: 10px; font-weight: 600; color: #555; cursor: pointer; border: 2px solid transparent; transition: 0.3s; }
    
    /* PUAN SWITCH */
    .points-section { background: #fdfaff; padding: 15px; border-radius: 12px; border: 1px solid #f3e5f5; margin-bottom: 20px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #8e44ad; }
    input:checked + .slider:before { transform: translateX(24px); }
    .delivery-section { background: #fff8e1; padding: 20px; border-radius: 12px; border: 1px solid #ffeeba; margin-bottom: 20px; }
</style>
{% endblock %}